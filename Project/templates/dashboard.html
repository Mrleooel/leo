{% extends "base.html" %}

{% block title %}数据看板 - 社区医疗健康平台{% endblock %}
{% block page_title %}数据看板{% endblock %}

{% block content %}
<div class="row">
    <!-- 统计卡片 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            总患者数
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-patients">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-injured fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            总医生数
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-doctors">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-md fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            今日预约
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="today-appointments">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            药品库存
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-medicines">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-pills fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row">
    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">就诊科室分布</h6>
            </div>
            <div class="card-body">
                <div id="department-chart" style="height: 400px;">
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-gray-300"></i>
                        <p class="mt-2 text-gray-500">加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">药品销量TOP10</h6>
            </div>
            <div class="card-body">
                <div id="medicine-chart" style="height: 400px;">
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-gray-300"></i>
                        <p class="mt-2 text-gray-500">加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 快速查询区域 -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">快速查询</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">患者预约查询</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="patient-search" placeholder="患者姓名">
                                <button class="btn btn-outline-primary" type="button" onclick="searchAppointments()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">医生查询</label>
                            <div class="input-group">
                                <select class="form-select" id="department-search">
                                    <option value="">选择科室</option>
                                    <option value="内科">内科</option>
                                    <option value="外科">外科</option>
                                    <option value="儿科">儿科</option>
                                    <option value="妇科">妇科</option>
                                    <option value="眼科">眼科</option>
                                    <option value="口腔科">口腔科</option>
                                </select>
                                <button class="btn btn-outline-primary" type="button" onclick="searchDoctors()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">药品库存查询</label>
                            <div class="input-group">
                                <select class="form-select" id="category-search">
                                    <option value="">选择类别</option>
                                    <option value="处方药">处方药</option>
                                    <option value="非处方药">非处方药</option>
                                    <option value="中药">中药</option>
                                </select>
                                <button class="btn btn-outline-primary" type="button" onclick="searchMedicines()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="search-results" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- 报表文件列表 -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">报表文件</h6>
                <button class="btn btn-sm btn-primary" onclick="loadReportFiles()">
                    <i class="fas fa-refresh me-2"></i>刷新
                </button>
            </div>
            <div class="card-body">
                <div id="report-files-list">
                    <div class="text-center py-3">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p class="mt-2 text-gray-500">加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--&lt;!&ndash; 系统设计图生成 &ndash;&gt;-->
<!--<div class="row">-->
<!--    <div class="col-12">-->
<!--        <div class="card shadow mb-4">-->
<!--            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">-->
<!--                <h6 class="m-0 font-weight-bold text-primary">系统设计图</h6>-->
<!--                <button class="btn btn-sm btn-primary" onclick="generateDiagrams()">-->
<!--                    <i class="fas fa-magic me-2"></i>生成图表-->
<!--                </button>-->
<!--            </div>-->
<!--            <div class="card-body">-->
<!--                <div id="diagrams-status">-->
<!--                    <div class="text-center py-3">-->
<!--                        <p class="text-muted">点击"生成图表"按钮开始生成系统设计图</p>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div id="diagrams-files" class="mt-3" style="display: none;">-->
<!--                    <h6>生成的图表文件：</h6>-->
<!--                    <div id="diagrams-files-list"></div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->
<!--{% endblock %}-->

{% block scripts %}
<script>
// 加载统计数据
function loadStatistics() {
    fetch('/dashboard/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading statistics:', data.error);
                return;
            }
            document.getElementById('total-patients').textContent = data.total_patients;
            document.getElementById('total-doctors').textContent = data.total_doctors;
            document.getElementById('today-appointments').textContent = data.today_appointments;
            document.getElementById('total-medicines').textContent = data.total_medicines;
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
            // 显示错误状态
            document.getElementById('total-patients').innerHTML = '<span class="text-danger">加载失败</span>';
            document.getElementById('total-doctors').innerHTML = '<span class="text-danger">加载失败</span>';
            document.getElementById('today-appointments').innerHTML = '<span class="text-danger">加载失败</span>';
            document.getElementById('total-medicines').innerHTML = '<span class="text-danger">加载失败</span>';
        });
}

// 加载科室分布图表
function loadDepartmentChart() {
    fetch('/dashboard/department_distribution')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('department-chart').innerHTML = 
                    '<div class="text-center py-5"><p class="text-danger">图表加载失败</p></div>';
                return;
            }
            Plotly.newPlot('department-chart', data.data, data.layout);
        })
        .catch(error => {
            console.error('Error loading department chart:', error);
            document.getElementById('department-chart').innerHTML = 
                '<div class="text-center py-5"><p class="text-danger">图表加载失败</p></div>';
        });
}

// 加载药品销量图表
function loadMedicineChart() {
    fetch('/dashboard/medicine_top10')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('medicine-chart').innerHTML = 
                    '<div class="text-center py-5"><p class="text-danger">图表加载失败</p></div>';
                return;
            }
            Plotly.newPlot('medicine-chart', data.data, data.layout);
        })
        .catch(error => {
            console.error('Error loading medicine chart:', error);
            document.getElementById('medicine-chart').innerHTML = 
                '<div class="text-center py-5"><p class="text-danger">图表加载失败</p></div>';
        });
}

// 搜索功能
function searchAppointments() {
    const patientName = document.getElementById('patient-search').value;
    const resultsDiv = document.getElementById('search-results');
    
    if (!patientName) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">请输入患者姓名</div>';
        return;
    }
    
    fetch(`/search/appointments?patient_name=${encodeURIComponent(patientName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-info">未找到相关预约</div>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>患者</th><th>医生</th><th>时间</th><th>状态</th></tr></thead><tbody>';
            data.forEach(apt => {
                html += `<tr><td>${apt.patient_name}</td><td>${apt.doctor_name}</td><td>${apt.date}</td><td>${apt.status}</td></tr>`;
            });
            html += '</tbody></table></div>';
            resultsDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Error searching appointments:', error);
            resultsDiv.innerHTML = '<div class="alert alert-danger">搜索失败</div>';
        });
}

function searchDoctors() {
    const department = document.getElementById('department-search').value;
    const resultsDiv = document.getElementById('search-results');
    
    if (!department) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">请选择科室</div>';
        return;
    }
    
    fetch(`/search/doctors?department=${encodeURIComponent(department)}`)
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-info">未找到相关医生</div>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>姓名</th><th>科室</th><th>职称</th><th>状态</th></tr></thead><tbody>';
            data.forEach(doc => {
                html += `<tr><td>${doc.name}</td><td>${doc.department}</td><td>${doc.title}</td><td>${doc.available ? '在岗' : '离岗'}</td></tr>`;
            });
            html += '</tbody></table></div>';
            resultsDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Error searching doctors:', error);
            resultsDiv.innerHTML = '<div class="alert alert-danger">搜索失败</div>';
        });
}

function searchMedicines() {
    const category = document.getElementById('category-search').value;
    const resultsDiv = document.getElementById('search-results');
    
    if (!category) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">请选择药品类别</div>';
        return;
    }
    
    fetch(`/search/medicines?category=${encodeURIComponent(category)}`)
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-info">未找到相关药品</div>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>药品名称</th><th>类别</th><th>价格</th><th>库存</th><th>厂家</th></tr></thead><tbody>';
            data.forEach(med => {
                html += `<tr><td>${med.name}</td><td>${med.category}</td><td>¥${med.price}</td><td>${med.stock}</td><td>${med.manufacturer}</td></tr>`;
            });
            html += '</tbody></table></div>';
            resultsDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Error searching medicines:', error);
            resultsDiv.innerHTML = '<div class="alert alert-danger">搜索失败</div>';
        });
}

// 加载报表文件列表
function loadReportFiles() {
    const filesListDiv = document.getElementById('report-files-list');
    filesListDiv.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i><p class="mt-2 text-gray-500">加载中...</p></div>';
    
    fetch('/report/list')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                filesListDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            if (data.files.length === 0) {
                filesListDiv.innerHTML = '<div class="text-center py-3"><p class="text-muted">暂无报表文件</p></div>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>文件名</th><th>大小</th><th>创建时间</th><th>操作</th></tr></thead><tbody>';
            data.files.forEach(file => {
                const sizeKB = Math.round(file.size / 1024);
                html += `<tr>
                    <td>${file.name}</td>
                    <td>${sizeKB} KB</td>
                    <td>${file.created}</td>
                    <td>
                        <a href="/report/download/${encodeURIComponent(file.name)}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download"></i> 下载
                        </a>
                    </td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            filesListDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading report files:', error);
            filesListDiv.innerHTML = '<div class="alert alert-danger">加载报表文件列表失败</div>';
        });
}

// 生成系统设计图
function generateDiagrams() {
    const statusDiv = document.getElementById('diagrams-status');
    const filesDiv = document.getElementById('diagrams-files');
    const filesListDiv = document.getElementById('diagrams-files-list');
    
    statusDiv.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i><p class="mt-2 text-gray-500">正在生成系统设计图，请稍候...</p></div>';
    filesDiv.style.display = 'none';
    
    fetch('/diagrams/generate')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let statusHtml = '<div class="alert alert-success"><h6>图表生成成功！</h6><ul>';
                data.results.forEach(([name, result]) => {
                    statusHtml += `<li><strong>${name}:</strong> ${result}</li>`;
                });
                statusHtml += '</ul></div>';
                statusDiv.innerHTML = statusHtml;
                
                if (data.files && data.files.length > 0) {
                    let filesHtml = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>文件名</th><th>操作</th></tr></thead><tbody>';
                    data.files.forEach(file => {
                        filesHtml += `<tr>
                            <td>${file}</td>
                            <td>
                                <a href="/diagrams/download/${encodeURIComponent(file)}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download"></i> 下载
                                </a>
                            </td>
                        </tr>`;
                    });
                    filesHtml += '</tbody></table></div>';
                    filesListDiv.innerHTML = filesHtml;
                    filesDiv.style.display = 'block';
                }
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger">图表生成失败: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Error generating diagrams:', error);
            statusDiv.innerHTML = '<div class="alert alert-danger">图表生成失败，请检查控制台错误信息</div>';
        });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadDepartmentChart();
    loadMedicineChart();
    loadReportFiles();
});
</script>
{% endblock %} 